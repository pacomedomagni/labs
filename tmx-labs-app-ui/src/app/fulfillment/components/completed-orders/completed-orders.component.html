<div class="content-wrapper">
  <!-- Filters Sidebar -->
  <aside class="filters-sidebar">
    <h3 class="filter-title">Filter Orders By</h3>

    <!-- Processed By Filter -->
    <div class="filter-section">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Processed By</mat-label>
        <mat-select multiple
                    [value]="selectedProcessedBy()"
                    (selectionChange)="selectedProcessedBy.set($event.value)">
          @for (user of availableProcessedBy(); track user.userID) {
            <mat-option [value]="user.userID">{{ user.displayName }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Processed Date - Start -->
    <div class="filter-section">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Start Date</mat-label>
        <input matInput [matDatepicker]="startPicker" [value]="startDate()" (dateChange)="onStartDateChange($event.value)">
        <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
        <mat-datepicker #startPicker></mat-datepicker>
      </mat-form-field>
    </div>

    <!-- Processed Date - End -->
    <div class="filter-section">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>End Date</mat-label>
        <input matInput [matDatepicker]="endPicker" [value]="endDate()" [min]="startDate()" (dateChange)="onEndDateChange($event.value)">
        <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
        <mat-datepicker #endPicker></mat-datepicker>
      </mat-form-field>
    </div>

    <!-- Clear Button -->
    <div class="clear-button-container">
      <button mat-flat-button
              color="primary"
              (click)="clearFilters()"
              [disabled]="isFilterDefault()"
              class="clear-button">
        CLEAR
      </button>
    </div>
  </aside>

  <!-- Orders Table -->
  <div class="orders-content">
    @if (loading()) {
      <div class="loading-container">
        <mat-spinner diameter="48"></mat-spinner>
      </div>
    } @else {
      <!-- Subheader -->
      <div class="orders-header">
        <div class="orders-count">
          <span>Completed Orders: <strong>{{ completedOrderCount().toLocaleString() }}</strong></span>
        </div>
        <div class="orders-actions">
          <button mat-flat-button color="primary" (click)="downloadCsv()" [disabled]="completedOrderCount() === 0">
            DOWNLOAD
          </button>
          <button mat-flat-button color="primary" (click)="printOrders()" [disabled]="completedOrderCount() === 0">
            PRINT
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" matSort class="cui-table orders-table">
          <!-- Order Number Column -->
          <ng-container matColumnDef="orderNumber">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Order #</th>
            <td mat-cell *matCellDef="let order">
              <a href="#" class="order-link" (click)="onOrderClick($event, order)">{{ order.orderNumber }}</a>
            </td>
          </ng-container>

          <!-- Processed Date Column -->
          <ng-container matColumnDef="processedDateTime">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Processed Date</th>
            <td mat-cell *matCellDef="let order">
              {{ order.processedDateTime | date:'M/d/yyyy h:mm:ss a' }}
            </td>
          </ng-container>

          <!-- Shipped Date Column -->
          <ng-container matColumnDef="shipDateTime">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Shipped Date</th>
            <td mat-cell *matCellDef="let order">
              {{ order.shipDateTime | date:'M/d/yyyy h:mm:ss a' }}
            </td>
          </ng-container>

          <!-- Processed By Column -->
          <ng-container matColumnDef="processedBy">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Processed By</th>
            <td mat-cell *matCellDef="let order">{{ order.processedBy }}</td>
          </ng-container>

          <!-- State Column -->
          <ng-container matColumnDef="state">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>State</th>
            <td mat-cell *matCellDef="let order">{{ order.state }}</td>
          </ng-container>

          <!-- Device Count Column -->
          <ng-container matColumnDef="deviceCount">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Device Count</th>
            <td mat-cell *matCellDef="let order">{{ order.deviceCount }}</td>
          </ng-container>

          <!-- Devices Column -->
          <ng-container matColumnDef="devices">
            <th mat-header-cell *matHeaderCellDef>Devices</th>
            <td mat-cell *matCellDef="let order">{{ (order.deviceSerialNumbers ?? []).join(', ') }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"
              tabindex="0"
              [attr.aria-label]="'Order ' + row.orderNumber + ', processed by ' + row.processedBy + ', ' + row.state + ', ' + row.deviceCount + ' devices'">
          </tr>
        </table>
      </div>

      <!-- Paginator -->
      <mat-paginator
        [pageSizeOptions]="[10, 25, 50, 100]"
        [pageSize]="10"
        showFirstLastButtons
        aria-label="Select page of completed orders">
      </mat-paginator>
    }
  </div>
</div>

<!-- Print-only section -->
<div class="print-only">
  <h2>Processed Orders</h2>
  <p class="print-subheader">
    Date Range: {{ startDate() | date:'M/d/yyyy' }} - {{ endDate() | date:'M/d/yyyy' }}
    | Processed By: {{ selectedProcessedByNames() }}
    | Total: {{ completedOrderCount() }}
  </p>
  <table class="print-table">
    <thead>
      <tr>
        <th>Order #</th>
        <th>Processed Date</th>
        <th>Shipped Date</th>
        <th>Processed By</th>
        <th>State</th>
        <th>Device Count</th>
        <th>Devices</th>
      </tr>
    </thead>
    <tbody>
      @for (order of filteredOrders(); track order.deviceOrderSeqID) {
        <tr>
          <td>{{ order.orderNumber }}</td>
          <td>{{ order.processedDateTime | date:'M/d/yyyy h:mm:ss a' }}</td>
          <td>{{ order.shipDateTime | date:'M/d/yyyy h:mm:ss a' }}</td>
          <td>{{ order.processedBy }}</td>
          <td>{{ order.state }}</td>
          <td>{{ order.deviceCount }}</td>
          <td>{{ (order.deviceSerialNumbers ?? []).join(', ') }}</td>
        </tr>
      }
    </tbody>
  </table>
</div>
